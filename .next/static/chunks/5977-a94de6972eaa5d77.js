"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5977],{45977:(e,t,r)=>{r.d(t,{W6:()=>m}),r(37876);var a=r(14232),o=r(14776),i=r(72170);let s=(void 0).NEXT_PUBLIC_SUPABASE_URL,n=(void 0).NEXT_PUBLIC_SUPABASE_ANON_KEY,l=s&&n&&"your_anon_key_here"!==n&&s.includes("supabase.co");l||console.warn("⚠️ Supabase credentials not configured. Using development mode.");let u=l?s:"https://dummy.supabase.co",d=(0,i.UU)(u,l?n:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1bW15Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2NDUxOTI4MDAsImV4cCI6MTk2MDc2ODgwMH0.dummy",{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0},global:{headers:{"x-application-name":"dudufisio-ai"}},db:{schema:"public"},realtime:{params:{eventsPerSecond:10}}}),c=e=>{var t,r,a;return(console.error("Supabase error:",e),null==e||null==(t=e.message)?void 0:t.includes("JWT"))?"Sess\xe3o expirada. Por favor, fa\xe7a login novamente.":(null==e||null==(r=e.message)?void 0:r.includes("duplicate"))?"Este registro j\xe1 existe.":(null==e||null==(a=e.message)?void 0:a.includes("foreign key"))?"Este registro est\xe1 sendo usado em outro lugar e n\xe3o pode ser removido.":(null==e?void 0:e.code)==="23505"?"Registro duplicado encontrado.":(null==e?void 0:e.code)==="PGRST116"?"Voc\xea n\xe3o tem permiss\xe3o para realizar esta a\xe7\xe3o.":(null==e?void 0:e.message)||"Ocorreu um erro ao processar sua solicita\xe7\xe3o."};class h{async initializeAuth(){try{console.log("\uD83D\uDD10 Initializing Supabase authentication...");let e=setTimeout(()=>{console.warn("⚠️ Auth initialization timeout, falling back to unauthenticated state"),this.updateState({user:null,session:null,loading:!1})},5e3);try{console.log("\uD83D\uDD0D Getting initial session...");let{data:{session:t},error:r}=await d.auth.getSession();if(r)throw console.warn("⚠️ Session error:",r.message),r;if(null==t?void 0:t.user){console.log("✅ Found active session, mapping user...");let e=await this.mapSupabaseUserToUser(t.user);this.updateState({user:e,session:t,loading:!1}),console.log("\uD83C\uDF89 User authenticated:",e.email)}else console.log("ℹ️ No active session found"),this.updateState({user:null,session:null,loading:!1});clearTimeout(e),console.log("\uD83D\uDC42 Setting up auth state change listener..."),d.auth.onAuthStateChange(async(e,t)=>{console.log("\uD83D\uDD04 Auth state changed:",e);try{if("SIGNED_IN"===e&&(null==t?void 0:t.user)){let e=await this.mapSupabaseUserToUser(t.user);this.updateState({user:e,session:t,loading:!1})}else if("SIGNED_OUT"===e)this.updateState({user:null,session:null,loading:!1});else if("TOKEN_REFRESHED"===e&&(null==t?void 0:t.user)){let e=await this.mapSupabaseUserToUser(t.user);this.updateState({user:e,session:t,loading:!1})}}catch(e){console.error("Error handling auth state change:",e)}}),console.log("✅ Auth initialization completed successfully")}catch(t){throw clearTimeout(e),t}}catch(e){console.error("❌ Auth initialization error:",e),console.log("\uD83D\uDD04 Falling back to unauthenticated state with mock auth support"),this.updateState({user:null,session:null,loading:!1})}}updateState(e){this.currentState={...this.currentState,...e},this.listeners.forEach(e=>e(this.currentState))}subscribe(e){return this.listeners.add(e),e(this.currentState),()=>{this.listeners.delete(e)}}getState(){return this.currentState}async login(e){try{if(this.shouldUseMockAuth(e))return this.mockLogin(e);let{data:t,error:r}=await d.auth.signInWithPassword({email:e.email,password:e.password});if(r)throw r;if(!t.user)throw Error("Login falhou");return await this.mapSupabaseUserToUser(t.user)}catch(t){if(this.shouldUseMockAuth(e))return this.mockLogin(e);throw Error(c(t))}}async register(e){try{let{data:t,error:r}=await d.auth.signUp({email:e.email,password:e.password,options:{data:{name:e.name,role:e.role,phone:e.phone}}});if(r)throw r;if(!t.user)throw Error("Registro falhou");let{error:a}=await d.from("user_profiles").insert({id:t.user.id,email:e.email,name:e.name,role:e.role,phone:e.phone,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});return a&&console.error("Profile creation error:",a),await this.mapSupabaseUserToUser(t.user)}catch(e){throw Error(c(e))}}async logout(){try{let{error:e}=await d.auth.signOut();if(e)throw e}catch(e){throw Error(c(e))}}async resetPassword(e){try{let{error:t}=await d.auth.resetPasswordForEmail(e,{redirectTo:"".concat(window.location.origin,"/reset-password")});if(t)throw t}catch(e){throw Error(c(e))}}async updatePassword(e){try{let{error:t}=await d.auth.updateUser({password:e});if(t)throw t}catch(e){throw Error(c(e))}}async updateProfile(e){try{let{data:{user:t},error:r}=await d.auth.updateUser({data:{name:e.name,phone:e.phone}});if(r)throw r;if(!t)throw Error("Usu\xe1rio n\xe3o encontrado");let{error:a}=await d.from("user_profiles").update({name:e.name,phone:e.phone,updated_at:new Date().toISOString()}).eq("id",t.id);if(a)throw a;return await this.mapSupabaseUserToUser(t)}catch(e){throw Error(c(e))}}async setup2FA(){try{let{data:e,error:t}=await d.auth.mfa.enroll({factorType:"totp"});if(t)throw t;return{secret:e.totp.secret,qrCode:e.totp.qr_code,backupCodes:[]}}catch(e){throw Error(c(e))}}async verify2FA(e,t){try{let{error:r}=await d.auth.mfa.challengeAndVerify({factorId:e,code:t});if(r)throw r}catch(e){throw Error(c(e))}}async get2FAFactors(){try{let{data:e,error:t}=await d.auth.mfa.listFactors();if(t)throw t;return e}catch(e){throw Error(c(e))}}async disable2FA(e){try{let{error:t}=await d.auth.mfa.unenroll({factorId:e});if(t)throw t}catch(e){throw Error(c(e))}}async getUserRole(e){try{let{data:t,error:r}=await d.from("user_profiles").select("role").eq("id",e).single();if(r)throw r;return t.role}catch(e){throw Error(c(e))}}async hasPermission(e){let t=this.currentState.user;if(!t)return!1;let r={[o.Xh.Admin]:["*"],[o.Xh.Therapist]:["patients:read","patients:write","appointments:read","appointments:write","treatments:read","treatments:write","reports:read","reports:write"],[o.Xh.Patient]:["profile:read","profile:write","appointments:read","exercises:read","progress:read"],[o.Xh.EducadorFisico]:["clients:read","clients:write","exercises:read","exercises:write","programs:read","programs:write"]}[t.role]||[];return r.includes("*")||r.includes(e)}async mapSupabaseUserToUser(e){var t,r,a,i,s,n,l,u;try{let{data:s}=await d.from("user_profiles").select("*").eq("id",e.id).single();return{id:e.id,email:e.email||"",name:(null==s?void 0:s.name)||(null==(t=e.user_metadata)?void 0:t.name)||"Usu\xe1rio",role:(null==s?void 0:s.role)||(null==(r=e.user_metadata)?void 0:r.role)||o.Xh.Patient,phone:(null==s?void 0:s.phone)||(null==(a=e.user_metadata)?void 0:a.phone)||"",avatarUrl:(null==s?void 0:s.avatar_url)||(null==(i=e.user_metadata)?void 0:i.avatar_url)||"",emailVerified:!!e.email_confirmed_at,createdAt:e.created_at,lastSignIn:e.last_sign_in_at,mfaEnabled:e.factors&&e.factors.length>0}}catch(t){return console.error("Error mapping user:",t),{id:e.id,email:e.email||"",name:(null==(s=e.user_metadata)?void 0:s.name)||"Usu\xe1rio",role:(null==(n=e.user_metadata)?void 0:n.role)||o.Xh.Patient,phone:(null==(l=e.user_metadata)?void 0:l.phone)||"",avatarUrl:(null==(u=e.user_metadata)?void 0:u.avatar_url)||"",emailVerified:!!e.email_confirmed_at,createdAt:e.created_at,lastSignIn:e.last_sign_in_at,mfaEnabled:!1}}}async loginWithGoogle(){try{let{error:e}=await d.auth.signInWithOAuth({provider:"google",options:{redirectTo:"".concat(window.location.origin,"/dashboard")}});if(e)throw e}catch(e){throw Error(c(e))}}async loginWithGitHub(){try{let{error:e}=await d.auth.signInWithOAuth({provider:"github",options:{redirectTo:"".concat(window.location.origin,"/dashboard")}});if(e)throw e}catch(e){throw Error(c(e))}}async refreshSession(){try{let{error:e}=await d.auth.refreshSession();if(e)throw e}catch(e){throw Error(c(e))}}isSessionExpired(){let e=this.currentState.session;return!e||new Date(1e3*e.expires_at)<=new Date}shouldUseMockAuth(e){let t=["admin@dudufisio.com","therapist@dudufisio.com","patient@dudufisio.com","educator@dudufisio.com"].includes(e.email)&&"demo123456"===e.password,r=!(void 0).VITE_SUPABASE_ANON_KEY||"your_anon_key_here"===(void 0).VITE_SUPABASE_ANON_KEY;return t||r}async mockLogin(e){await new Promise(e=>setTimeout(e,500));let t={"admin@dudufisio.com":{id:"user_admin",name:"Admin",email:"admin@dudufisio.com",role:"Admin",avatarUrl:"https://i.pravatar.cc/150?u=user_admin",phone:"(11) 98765-4321"},"therapist@dudufisio.com":{id:"user_1",name:"Dr. Roberto",email:"therapist@dudufisio.com",role:"Therapist",avatarUrl:"https://i.pravatar.cc/150?u=user_1",phone:"(11) 91234-5678"},"patient@dudufisio.com":{id:"user_patient_1",name:"Ana Beatriz Costa",email:"patient@dudufisio.com",role:"Patient",avatarUrl:"https://picsum.photos/id/1027/200/200",patientId:"1",phone:"(11) 98765-4321"},"educator@dudufisio.com":{id:"user_educator_1",name:"Dra. Juliana",email:"educator@dudufisio.com",role:"EducadorFisico",avatarUrl:"https://i.pravatar.cc/150?u=user_educator_1",phone:"(11) 91111-2222"}}[e.email];if(!t)throw Error("Credenciais inv\xe1lidas");let r={access_token:"mock_access_token",expires_at:Math.floor(Date.now()/1e3)+3600,user:{id:t.id,email:t.email}};return this.updateState({user:t,session:r,loading:!1}),console.log("\uD83C\uDFAD Mock authentication successful for:",t.email),t}constructor(){this.listeners=new Set,this.currentState={user:null,session:null,loading:!0},this.initializeAuth()}}new h;let p=(0,a.createContext)(void 0),m=()=>{let e=(0,a.useContext)(p);if(void 0===e)throw Error("useSupabaseAuth must be used within a SupabaseAuthProvider");return e}}}]);